{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Carrito de Compras</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2">
            <div id="cart-items" class="space-y-4">
                <!-- Cart items will be loaded here by JavaScript -->
            </div>
            
            <div id="empty-cart" class="text-center py-12 hidden">
                <i class="fas fa-shopping-cart text-gray-400 text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Tu carrito está vacío</h3>
                <p class="text-gray-500 mb-6">Agrega algunos productos para comenzar</p>
                <a href="{% url 'tienda:home' %}" 
                   class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors">
                    Continuar Comprando
                </a>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-gray-50 rounded-lg p-6 sticky top-24">
                <h3 class="text-lg font-semibold mb-4">Resumen del Pedido</h3>
                
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Envío:</span>
                        <span id="shipping">$5.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Impuestos:</span>
                        <span id="taxes">$0.00</span>
                    </div>
                    <div class="border-t border-gray-300 pt-3">
                        <div class="flex justify-between font-semibold text-lg">
                            <span>Total:</span>
                            <span id="total">$0.00</span>
                        </div>
                    </div>
                </div>

                <button id="checkout-btn" 
                        class="w-full bg-primary text-white py-3 px-6 rounded-lg font-semibold hover:bg-secondary transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                        disabled>
                    Proceder al Pago
                </button>

                <div class="mt-4 text-center space-y-2">
                    <a href="{% url 'tienda:home' %}" class="block text-primary hover:underline">
                        <i class="fas fa-arrow-left mr-1"></i>Continuar Comprando
                    </a>
                    <button onclick="clearCart()" class="text-red-500 hover:underline text-sm">
                        <i class="fas fa-trash mr-1"></i>Limpiar Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para obtener información del producto desde la API
async function getProductInfo(productId) {
    try {
        const response = await fetch(`/api/productos/${productId}/`);
        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('Error obteniendo información del producto:', error);
    }
    return null;
}

async function loadCart() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const cartItemsContainer = document.getElementById('cart-items');
    const emptyCartDiv = document.getElementById('empty-cart');
    
    if (cart.length === 0) {
        cartItemsContainer.innerHTML = '';
        emptyCartDiv.classList.remove('hidden');
        document.getElementById('checkout-btn').disabled = true;
        updateSummary();
        return;
    }
    
    emptyCartDiv.classList.add('hidden');
    document.getElementById('checkout-btn').disabled = false;
    
    // Obtener información actualizada de productos si no tienen imagen
    const updatedCart = [];
    for (let item of cart) {
        if (!item.image) {
            const productInfo = await getProductInfo(item.id);
            if (productInfo && productInfo.imagen) {
                item.image = productInfo.imagen;
            }
        }
        updatedCart.push(item);
    }
    
    // Actualizar localStorage con las imágenes
    localStorage.setItem('cart', JSON.stringify(updatedCart));
    
    cartItemsContainer.innerHTML = updatedCart.map(item => `
        <div class="bg-white rounded-lg shadow-md p-6 flex items-center space-x-4">
            <div class="w-20 h-20 bg-gray-200 rounded-lg overflow-hidden">
                ${item.image ? 
                    `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">` : 
                    `<div class="w-full h-full flex items-center justify-center"><i class="fas fa-image text-gray-400"></i></div>`
                }
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-lg">${item.name}</h3>
                <p class="text-gray-600">$${item.price}</p>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})" 
                        class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors">
                    <i class="fas fa-minus text-sm"></i>
                </button>
                <span class="w-8 text-center font-semibold">${item.quantity}</span>
                <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})" 
                        class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus text-sm"></i>
                </button>
            </div>
            <div class="text-right">
                <p class="font-semibold text-lg">$${(item.price * item.quantity).toFixed(2)}</p>
                <button onclick="removeFromCart(${item.id})" 
                        class="text-red-500 hover:text-red-700 transition-colors mt-1">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    updateSummary();
}

function updateQuantity(productId, newQuantity) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    if (newQuantity <= 0) {
        removeFromCart(productId);
        return;
    }
    
    const itemIndex = cart.findIndex(item => item.id === productId);
    if (itemIndex !== -1) {
        cart[itemIndex].quantity = newQuantity;
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
        updateCartCount();
    }
}

function removeFromCart(productId) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    cart = cart.filter(item => item.id !== productId);
    localStorage.setItem('cart', JSON.stringify(cart));
    loadCart();
    updateCartCount();
    showNotification('Producto eliminado del carrito');
}

function updateSummary() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shipping = cart.length > 0 ? 5.00 : 0;
    const taxes = subtotal * 0.1; // 10% tax
    const total = subtotal + shipping + taxes;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('shipping').textContent = `$${shipping.toFixed(2)}`;
    document.getElementById('taxes').textContent = `$${taxes.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
}

function clearCart() {
    localStorage.removeItem('cart');
    loadCart();
    updateCartCount();
    showNotification('Carrito vaciado');
}

// Load cart when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCart();
});

// Checkout functionality
document.getElementById('checkout-btn').addEventListener('click', function() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (cart.length === 0) return;
    
    // Simulate checkout process
    showNotification('Procesando pedido...');
    
    setTimeout(() => {
        clearCart();
        showNotification('¡Pedido realizado con éxito!');
    }, 2000);
});
</script>
{% endblock %}
